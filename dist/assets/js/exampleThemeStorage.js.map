{"version":3,"file":"exampleThemeStorage.js","sources":["../../../src/shared/storages/base.ts","../../../src/shared/storages/exampleThemeStorage.ts"],"sourcesContent":["export enum StorageType {\r\n  Local = 'local',\r\n  Sync = 'sync',\r\n  Managed = 'managed',\r\n  Session = 'session',\r\n}\r\n\r\ntype ValueOrUpdate<D> = D | ((prev: D) => Promise<D> | D);\r\n\r\nexport type BaseStorage<D> = {\r\n  get: () => Promise<D>;\r\n  set: (value: ValueOrUpdate<D>) => Promise<void>;\r\n  getSnapshot: () => D | null;\r\n  subscribe: (listener: () => void) => () => void;\r\n};\r\n\r\nexport function createStorage<D>(key: string, fallback: D, config?: { storageType?: StorageType }): BaseStorage<D> {\r\n  let cache: D | null = null;\r\n  let listeners: Array<() => void> = [];\r\n  const storageType = config?.storageType ?? StorageType.Local;\r\n\r\n  const _getDataFromStorage = async (): Promise<D> => {\r\n    if (chrome.storage[storageType] === undefined) {\r\n      throw new Error(`Check your storage permission into manifest.json: ${storageType} is not defined`);\r\n    }\r\n    const value = await chrome.storage[storageType].get([key]);\r\n    return value[key] ?? fallback;\r\n  };\r\n\r\n  const _emitChange = () => {\r\n    listeners.forEach(listener => listener());\r\n  };\r\n\r\n  const set = async (valueOrUpdate: ValueOrUpdate<D>) => {\r\n    if (typeof valueOrUpdate === 'function') {\r\n      // eslint-disable-next-line no-prototype-builtins\r\n      if (valueOrUpdate.hasOwnProperty('then')) {\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        cache = await valueOrUpdate(cache);\r\n      } else {\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        cache = valueOrUpdate(cache);\r\n      }\r\n    } else {\r\n      cache = valueOrUpdate;\r\n    }\r\n    await chrome.storage[storageType].set({ [key]: cache });\r\n    _emitChange();\r\n  };\r\n\r\n  const subscribe = (listener: () => void) => {\r\n    listeners = [...listeners, listener];\r\n    return () => {\r\n      listeners = listeners.filter(l => l !== listener);\r\n    };\r\n  };\r\n\r\n  const getSnapshot = () => {\r\n    return cache;\r\n  };\r\n\r\n  _getDataFromStorage().then(data => {\r\n    cache = data;\r\n    _emitChange();\r\n  });\r\n\r\n  return {\r\n    get: _getDataFromStorage,\r\n    set,\r\n    getSnapshot,\r\n    subscribe,\r\n  };\r\n}\r\n","import { BaseStorage, createStorage, StorageType } from '@src/shared/storages/base';\r\n\r\ntype Theme = 'light' | 'dark';\r\n\r\ntype ThemeStorage = BaseStorage<Theme> & {\r\n  toggle: () => void;\r\n};\r\n\r\nconst storage = createStorage<Theme>('theme-storage-key', 'light', {\r\n  storageType: StorageType.Local,\r\n});\r\n\r\nconst exampleThemeStorage: ThemeStorage = {\r\n  ...storage,\r\n  // TODO: extends your own methods\r\n  toggle: () => {\r\n    storage.set(currentTheme => {\r\n      return currentTheme === 'light' ? 'dark' : 'light';\r\n    });\r\n  },\r\n};\r\n\r\nexport default exampleThemeStorage;\r\n"],"names":["StorageType"],"mappings":"AAAY,IAAA,gCAAAA,iBAAL;AACLA,eAAA,OAAQ,IAAA;AACRA,eAAA,MAAO,IAAA;AACPA,eAAA,SAAU,IAAA;AACVA,eAAA,SAAU,IAAA;AAJAA,SAAAA;AAAA,GAAA,eAAA,CAAA,CAAA;AAgBI,SAAA,cAAiB,KAAa,UAAa,QAAwD;AACjH,MAAI,QAAkB;AACtB,MAAI,YAA+B,CAAA;AAC7B,QAAA,eAAc,iCAAQ,gBAAe;AAE3C,QAAM,sBAAsB,YAAwB;AAClD,QAAI,OAAO,QAAQ,WAAW,MAAM,QAAW;AAC7C,YAAM,IAAI,MAAM,qDAAqD,WAAW,iBAAiB;AAAA,IACnG;AACM,UAAA,QAAQ,MAAM,OAAO,QAAQ,WAAW,EAAE,IAAI,CAAC,GAAG,CAAC;AAClD,WAAA,MAAM,GAAG,KAAK;AAAA,EAAA;AAGvB,QAAM,cAAc,MAAM;AACd,cAAA,QAAQ,CAAY,aAAA,SAAU,CAAA;AAAA,EAAA;AAGpC,QAAA,MAAM,OAAO,kBAAoC;AACjD,QAAA,OAAO,kBAAkB,YAAY;AAEnC,UAAA,cAAc,eAAe,MAAM,GAAG;AAGhC,gBAAA,MAAM,cAAc,KAAK;AAAA,MAAA,OAC5B;AAGL,gBAAQ,cAAc,KAAK;AAAA,MAC7B;AAAA,IAAA,OACK;AACG,cAAA;AAAA,IACV;AACM,UAAA,OAAO,QAAQ,WAAW,EAAE,IAAI,EAAE,CAAC,GAAG,GAAG,MAAA,CAAO;AAC1C;EAAA;AAGR,QAAA,YAAY,CAAC,aAAyB;AAC9B,gBAAA,CAAC,GAAG,WAAW,QAAQ;AACnC,WAAO,MAAM;AACX,kBAAY,UAAU,OAAO,CAAK,MAAA,MAAM,QAAQ;AAAA,IAAA;AAAA,EAClD;AAGF,QAAM,cAAc,MAAM;AACjB,WAAA;AAAA,EAAA;AAGW,sBAAA,EAAE,KAAK,CAAQ,SAAA;AACzB,YAAA;AACI;EAAA,CACb;AAEM,SAAA;AAAA,IACL,KAAK;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ;AClEA,MAAM,UAAU,cAAqB,qBAAqB,SAAS;AAAA,EACjE,aAAa,YAAY;AAC3B,CAAC;AAED,MAAM,sBAAoC;AAAA,EACxC,GAAG;AAAA;AAAA,EAEH,QAAQ,MAAM;AACZ,YAAQ,IAAI,CAAgB,iBAAA;AACnB,aAAA,iBAAiB,UAAU,SAAS;AAAA,IAAA,CAC5C;AAAA,EACH;AACF;"}