{"version":3,"file":"exampleThemeStorage.mvPT3a0L.js","sources":["../../../src/shared/storages/base.ts","../../../src/shared/storages/exampleThemeStorage.ts"],"sourcesContent":["export enum StorageType {\r\n  Local = 'local',\r\n  Sync = 'sync',\r\n  Managed = 'managed',\r\n  Session = 'session',\r\n}\r\n\r\ntype ValueOrUpdate<D> = D | ((prev: D) => Promise<D> | D);\r\n\r\nexport type BaseStorage<D> = {\r\n  get: () => Promise<D>;\r\n  set: (value: ValueOrUpdate<D>) => Promise<void>;\r\n  getSnapshot: () => D | null;\r\n  subscribe: (listener: () => void) => () => void;\r\n};\r\n\r\nexport function createStorage<D>(key: string, fallback: D, config?: { storageType?: StorageType }): BaseStorage<D> {\r\n  let cache: D | null = null;\r\n  let listeners: Array<() => void> = [];\r\n  const storageType = config?.storageType ?? StorageType.Local;\r\n\r\n  const _getDataFromStorage = async (): Promise<D> => {\r\n    if (chrome.storage[storageType] === undefined) {\r\n      throw new Error(`Check your storage permission into manifest.json: ${storageType} is not defined`);\r\n    }\r\n    const value = await chrome.storage[storageType].get([key]);\r\n    return value[key] ?? fallback;\r\n  };\r\n\r\n  const _emitChange = () => {\r\n    listeners.forEach(listener => listener());\r\n  };\r\n\r\n  const set = async (valueOrUpdate: ValueOrUpdate<D>) => {\r\n    if (typeof valueOrUpdate === 'function') {\r\n      // eslint-disable-next-line no-prototype-builtins\r\n      if (valueOrUpdate.hasOwnProperty('then')) {\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        cache = await valueOrUpdate(cache);\r\n      } else {\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        cache = valueOrUpdate(cache);\r\n      }\r\n    } else {\r\n      cache = valueOrUpdate;\r\n    }\r\n    await chrome.storage[storageType].set({ [key]: cache });\r\n    _emitChange();\r\n  };\r\n\r\n  const subscribe = (listener: () => void) => {\r\n    listeners = [...listeners, listener];\r\n    return () => {\r\n      listeners = listeners.filter(l => l !== listener);\r\n    };\r\n  };\r\n\r\n  const getSnapshot = () => {\r\n    return cache;\r\n  };\r\n\r\n  _getDataFromStorage().then(data => {\r\n    cache = data;\r\n    _emitChange();\r\n  });\r\n\r\n  return {\r\n    get: _getDataFromStorage,\r\n    set,\r\n    getSnapshot,\r\n    subscribe,\r\n  };\r\n}\r\n","import { BaseStorage, createStorage, StorageType } from '@src/shared/storages/base';\r\n\r\ntype Theme = 'light' | 'dark';\r\n\r\ntype ThemeStorage = BaseStorage<Theme> & {\r\n  toggle: () => void;\r\n};\r\n\r\nconst storage = createStorage<Theme>('theme-storage-key', 'light', {\r\n  storageType: StorageType.Local,\r\n});\r\n\r\nconst exampleThemeStorage: ThemeStorage = {\r\n  ...storage,\r\n  // TODO: extends your own methods\r\n  toggle: () => {\r\n    storage.set(currentTheme => {\r\n      return currentTheme === 'light' ? 'dark' : 'light';\r\n    });\r\n  },\r\n};\r\n\r\nexport default exampleThemeStorage;\r\n"],"names":["StorageType","createStorage","key","fallback","config","cache","listeners","storageType","_getDataFromStorage","_emitChange","listener","set","valueOrUpdate","subscribe","l","getSnapshot","data","storage","exampleThemeStorage","currentTheme"],"mappings":"AAAY,IAAAA,GAAAA,IACVA,EAAA,MAAQ,QACRA,EAAA,KAAO,OACPA,EAAA,QAAU,UACVA,EAAA,QAAU,UAJAA,IAAAA,GAAA,CAAA,CAAA,EAgBI,SAAAC,EAAiBC,EAAaC,EAAaC,EAAwD,CACjH,IAAIC,EAAkB,KAClBC,EAA+B,CAAA,EAC7B,MAAAC,GAAcH,GAAA,YAAAA,EAAQ,cAAe,QAErCI,EAAsB,SAAwB,CAClD,GAAI,OAAO,QAAQD,CAAW,IAAM,OAClC,MAAM,IAAI,MAAM,qDAAqDA,CAAW,iBAAiB,EAG5F,OADO,MAAM,OAAO,QAAQA,CAAW,EAAE,IAAI,CAACL,CAAG,CAAC,GAC5CA,CAAG,GAAKC,CAAA,EAGjBM,EAAc,IAAM,CACdH,EAAA,QAAoBI,GAAAA,EAAU,CAAA,CAAA,EAGpCC,EAAM,MAAOC,GAAoC,CACjD,OAAOA,GAAkB,WAEvBA,EAAc,eAAe,MAAM,EAG7BP,EAAA,MAAMO,EAAcP,CAAK,EAIjCA,EAAQO,EAAcP,CAAK,EAGrBA,EAAAO,EAEJ,MAAA,OAAO,QAAQL,CAAW,EAAE,IAAI,CAAE,CAACL,CAAG,EAAGG,CAAA,CAAO,EAC1CI,GAAA,EAGRI,EAAaH,IACLJ,EAAA,CAAC,GAAGA,EAAWI,CAAQ,EAC5B,IAAM,CACXJ,EAAYA,EAAU,OAAYQ,GAAAA,IAAMJ,CAAQ,CAAA,GAI9CK,EAAc,IACXV,EAGW,OAAAG,EAAA,EAAE,KAAaQ,GAAA,CACzBX,EAAAW,EACIP,GAAA,CACb,EAEM,CACL,IAAKD,EACL,IAAAG,EACA,YAAAI,EACA,UAAAF,CAAA,CAEJ,CClEA,MAAMI,EAAUhB,EAAqB,oBAAqB,QAAS,CACjE,YAAaD,EAAY,KAC3B,CAAC,EAEKkB,EAAoC,CACxC,GAAGD,EAEH,OAAQ,IAAM,CACZA,EAAQ,IAAoBE,GACnBA,IAAiB,QAAU,OAAS,OAC5C,CACH,CACF"}